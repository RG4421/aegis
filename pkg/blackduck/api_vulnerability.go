package blackduck

import (
	"encoding/json"
	"fmt"
	"net/http"
	"strings"
)

func (cli *BlackDuckClient) GetVulnerabilityBOM(projectID string, versionID string) (resp *VulnerabilityBOMResponse, err error) {
	resp = &VulnerabilityBOMResponse{}
	endpoint := strings.Replace(getVulnerabilityBOM, "{PROJECT_ID}", projectID, 1)
	endpoint = strings.Replace(endpoint, "{VERSION_ID}", versionID, 1)

	var body []byte
	body, err = cli.executeRequest(http.MethodGet, fmt.Sprintf("%s?sort=project.name", endpoint), nil, nil)
	if err == nil {
		err = json.Unmarshal(body, resp)
		if err != nil {
			err = fmt.Errorf("error while parsing vulnerability bom response - %s", err.Error())
		}
	} else {
		err = fmt.Errorf("error while getting vulnerability bom for [%s|%s]", projectID, versionID)
	}

	return resp, err
}

func (cli *BlackDuckClient) GetComponentInformation(projectID string, projectVersionID string) (resp *ComponentResponse, err error) {
	resp = &ComponentResponse{}
	endpoint := strings.Replace(getComponents, "{PROJECT_ID}", projectID, 1)
	endpoint = strings.Replace(endpoint, "{VERSION_ID}", projectVersionID, 1)

	var body []byte
	body, err = cli.executeRequest(http.MethodGet, endpoint, nil, nil)
	if err == nil {
		err = json.Unmarshal(body, resp)
		if err != nil {
			err = fmt.Errorf("error while parsing component response - %s", err.Error())
		}
	} else {
		err = fmt.Errorf("error while getting components for [%s|%s] - %s", projectID, projectVersionID, err.Error())
	}

	return resp, err
}

func (cli *BlackDuckClient) GetPolicyStatus(projectID, projectVersionID, componentID, componentVersionID string) (resp *PolicyRulesResp, err error) {
	resp = &PolicyRulesResp{}
	endpoint := strings.Replace(getPolicyStatus, "{PROJECT_ID}", projectID, 1)
	endpoint = strings.Replace(endpoint, "{VERSION_ID}", projectVersionID, 1)
	endpoint = strings.Replace(endpoint, "{COMPONENT_ID}", componentID, 1)
	endpoint = strings.Replace(endpoint, "{COMPONENT_VERSION}", componentVersionID, 1)

	var body []byte
	body, err = cli.executeRequest(http.MethodGet, endpoint, nil, nil)
	if err == nil {
		err = json.Unmarshal(body, resp)
		if err != nil {
			err = fmt.Errorf("error while parsing component policy response - %s", err.Error())
		}
	} else {
		err = fmt.Errorf("error while getting component policies for [%s|%s|%s|%s]", projectID, projectVersionID, componentID, componentVersionID)
	}

	return resp, err
}

func (cli *BlackDuckClient) GetComponentVulnerabilitiesForProject(projectID, projectVersionID, componentID, componentVersionID string) (resp *ProjectComponentVulnerabilityResponse, err error) {
	resp = &ProjectComponentVulnerabilityResponse{}
	endpoint := strings.Replace(getComponentVulnerability, "{PROJECT_ID}", projectID, 1)
	endpoint = strings.Replace(endpoint, "{VERSION_ID}", projectVersionID, 1)
	endpoint = strings.Replace(endpoint, "{COMPONENT_ID}", componentID, 1)
	endpoint = strings.Replace(endpoint, "{COMPONENT_VERSION}", componentVersionID, 1)

	var body []byte
	body, err = cli.executeRequest(http.MethodGet, endpoint, nil, nil)
	if err == nil {
		err = json.Unmarshal(body, resp)
		if err != nil {
			err = fmt.Errorf("error while parsing component vulnerability response - %s", err.Error())
		}
	} else {
		err = fmt.Errorf("error while getting component vulnerabilities for [%s|%s|%s|%s]", projectID, projectVersionID, componentID, componentVersionID)
	}

	return resp, err
}

func (cli *BlackDuckClient) GetComponentVulnerabilities(componentID, componentVersionID string) (resp *ComponentVulnerabilityResponse, err error) {
	resp = &ComponentVulnerabilityResponse{}
	endpoint := strings.Replace(getComponentVulnerabilityNoProject, "{COMPONENT_ID}", componentID, 1)
	endpoint = strings.Replace(endpoint, "{COMPONENT_VERSION}", componentVersionID, 1)

	var body []byte
	body, err = cli.executeRequest(http.MethodGet, endpoint, nil, nil)
	if err == nil {
		err = json.Unmarshal(body, resp)
		if err != nil {
			err = fmt.Errorf("error while parsing component vulnerability response - %s", err.Error())
		}
	} else {
		err = fmt.Errorf("error while getting component vulnerabilities for [%s|%s]", componentID, componentVersionID)
	}

	return resp, err
}

func (cli *BlackDuckClient) getVulnerabilityDetails(vulnID string) (resp *VulnerabilityInfoResponse, err error) {
	resp = &VulnerabilityInfoResponse{}
	endpoint := strings.Replace(getVulnerabilityInfo, "{VULNERABILITY_ID}", vulnID, 1)

	var body []byte
	body, err = cli.executeRequest(http.MethodGet, endpoint, nil, map[string]string{
		"Accept": "application/vnd.blackducksoftware.vulnerability-2+json", // this header is required to get the full vulnerability object
	})
	if err == nil {
		err = json.Unmarshal(body, resp)
		if err != nil {
			err = fmt.Errorf("error while parsing component vulnerability response - %s", err.Error())
		}
	} else {
		err = fmt.Errorf("error while getting black duck vulnerability info for [%s] - %s", vulnID, err.Error())
	}

	return resp, err
}
